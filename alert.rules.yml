groups:
  - name: monitoring.rules
    rules:
      - alert: High5xxErrorRate
        expr: |
          sum(rate(nginx_http_response_total{status=~"5.."}[5m]))
          /
          sum(rate(nginx_http_response_total[5m])) > 0.01
        for: 2m
        labels:
          severity: page
          team: devops
        annotations:
          summary: "Рост 5xx ошибок: доля 5xx > 1% за 5m"
          description: "Доля ответов с кодом 5xx за последние 5 минут превысила 1% ({{ $value }}) — проверьте сервисы, внешние зависимости и логи."
      - alert: Spike502504
        expr: sum(increase(nginx_http_response_total{status=~"502|504"}[1m])) > 10
        for: 1m
        labels:
          severity: page
          team: devops
        annotations:
          summary: "Резкий рост 502/504 ошибок > 10 за 1m"
          description: "За последнюю минуту обнаружено более 10 ответов с кодом 502 или 504 ({{ $value }}) — проверьте балансировщик, прокси и бэкенды, посмотрите логи и метрики связей."
