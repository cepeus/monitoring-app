groups:
  - name: monitoring.rules
    rules:
      - alert: SlowRequest
        expr: histogram_quantile(0.5, sum(rate(http_request_duration_seconds_bucket[5m])) by (le, method, route, status)) > 0.6
        for: 1m
        labels:
          severity: page
          team: devops
        annotations:
          summary: "Slow requests detected on route {{ $labels.route }}"
          description: "50th percentile request latency is > 0.6s for route {{ $labels.route }} (method={{ $labels.method }})"
      - alert: High5xxErrorRate
        expr: |
          sum(rate(http_request_duration_seconds_count{status=~"5.."}[5m]))
          /
          sum(rate(http_request_duration_seconds_count[5m])) > 0.01
        for: 2m
        labels:
          severity: page
          team: devops
        annotations:
          summary: "Рост 5xx ошибок: доля 5xx > 1% за 5m"
          description: "Доля ответов с кодом 5xx за последние 5 минут превысила 1% ({{ $value }}) — проверьте сервисы, внешние зависимости и логи."
      - alert: Spike502504
        expr: sum(increase(http_request_duration_seconds_count{status=~"502|504"}[1m])) > 10
        for: 1m
        labels:
          severity: page
          team: devops
        annotations:
          summary: "Резкий рост 502/504 ошибок > 10 за 1m"
          description: "За последнюю минуту обнаружено более 10 ответов с кодом 502 или 504 ({{ $value }}) — проверьте балансировщик, прокси и бэкенды, посмотрите логи и метрики связей."
