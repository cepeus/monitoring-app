{
  "title": "NGINX Overview",
  "schemaVersion": 36,
  "version": 1,
  "refresh": "15s",
  "time": { "from": "now-1h", "to": "now" },
  "tags": ["nginx", "prometheus", "sre"],
  "panels": [
    {
      "type": "stat",
      "title": "State",
      "targets": [ { "expr": "max(up{job=\"nginx_exporter\"})" } ],
      "description": "Статус nginx_exporter (1 = UP, 0 = DOWN)",
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center"
      },
      "fieldConfig": {
        "defaults": {
          "mappings": [
            {
              "type": "value",
              "options": {
                "0": { "text": "DOWN", "color": "red" },
                "1": { "text": "UP", "color": "green" }
              }
            }
          ],
          "thresholds": { "mode": "absolute", "steps": [ { "color": "red", "value": 0 }, { "color": "green", "value": 1 } ] }
        }
      },
      "gridPos": { "x": 0, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "stat",
      "title": "RPS",
      "targets": [ { "expr": "sum(rate(nginx_http_requests_total{job=\"nginx_exporter\"}[1m]))" } ],
      "description": "Суммарная частота запросов (requests/sec) по всем nginx-инстансам",
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "graphMode": "area" },
      "gridPos": { "x": 6, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "stat",
      "title": "Active Connections",
      "description": "Сумма nginx_connections_reading + writing + waiting (nginx_exporter)",
      "targets": [
        {
          "expr": "sum(nginx_connections_reading) + sum(nginx_connections_writing) + sum(nginx_connections_waiting)",
          "legendFormat": "active_connections"
        }
      ],
      "options": { "reduceOptions": { "calcs": ["lastNotNull"] }, "colorMode": "value", "graphMode": "none" },
      "fieldConfig": { "defaults": { "unit": "short" } },
      "gridPos": { "x": 12, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "stat",
      "title": "Requests (24h)",
      "description": "Суммы по статусам 2xx/3xx/4xx/5xx за 24 часа",
      "targets": [
        { "expr": "sum(increase(nginx_http_response_total{status=~\"2..\"}[24h]))", "legendFormat": "2xx" },
        { "expr": "sum(increase(nginx_http_response_total{status=~\"3..\"}[24h]))", "legendFormat": "3xx" },
        { "expr": "sum(increase(nginx_http_response_total{status=~\"4..\"}[24h]))", "legendFormat": "4xx" },
        { "expr": "sum(increase(nginx_http_response_total{status=~\"5..\"}[24h]))", "legendFormat": "5xx" }
      ],
      "options": {
        "reduceOptions": { "calcs": ["lastNotNull"] },
        "graphMode": "none",
        "colorMode": "value",
        "orientation": "auto",
        "justifyMode": "center"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": { "mode": "absolute", "steps": [ { "color": "green", "value": null } ] }
        }
      },
      "gridPos": { "x": 18, "y": 0, "w": 6, "h": 3 }
    },
    {
      "type": "timeseries",
      "title": "RPS (Ingress)",
      "targets": [
        {
          "expr": "sum(rate(nginx_http_requests_total[1m]))",
          "legendFormat": "rps"
        }
      ],
      "description": "Суммарная частота входящих запросов (requests/sec)",
      "gridPos": { "x": 0, "y": 3, "w": 12, "h": 6 }
    },
    {
      "type": "timeseries",
      "title": "NGINX Connections",
      "targets": [
        { "expr": "nginx_connections_reading", "legendFormat": "reading" },
        { "expr": "nginx_connections_writing", "legendFormat": "writing" },
        { "expr": "nginx_connections_waiting", "legendFormat": "waiting" }
      ],
      "description": "Количество подключений nginx: reading / writing / waiting",
      "gridPos": { "x": 12, "y": 3, "w": 12, "h": 6 }
    },
    {
      "type": "timeseries",
      "title": "4xx by Code",
      "targets": [
        { "expr": "round(sum by(status) (increase(nginx_http_response_total{status=~\"4..\"}[1m])))", "legendFormat": "{{status}}" }
      ],
      "description": "Количество запросов по статусам 4xx за последнюю минуту (requests per 1m)",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 0 } },
      "gridPos": { "x": 0, "y": 9, "w": 12, "h": 5 }
    },
    {
      "type": "timeseries",
      "title": "5xx by Code",
      "targets": [
        { "expr": "round(sum by(status) (increase(nginx_http_response_total{status=~\"5..\"}[1m])))", "legendFormat": "{{status}}" }
      ],
      "description": "Количество запросов по статусам 5xx за последнюю минуту (requests per 1m)",
      "fieldConfig": { "defaults": { "unit": "short", "decimals": 0 } },
      "gridPos": { "x": 12, "y": 9, "w": 12, "h": 5 }
    },
    {
      "type": "timeseries",
      "title": "Top routes by RPS",
      "targets": [
        {
          "expr": "topk(10, sum by (url) (rate(nginx_http_requests_total{url!~\"^/ws/|/event\"}[1m])))",
          "legendFormat": "{{url}}"
        }
      ],
      "description": "Top 10 routes by requests per second",
      "gridPos": { "x": 0, "y": 14, "w": 12, "h": 5 }
    },
    {
      "type": "timeseries",
      "title": "Avg request_time by route",
      "targets": [
        {
          "expr": "sum by (url) (rate(nginx_http_request_duration_seconds_sum{url!~\"^/ws/|/event\"}[5m])) / sum by (url) (rate(nginx_http_request_duration_seconds_count{url!~\"^/ws/|/event\"}[5m]))",
          "legendFormat": "{{url}}"
        }
      ],
      "description": "Average request duration per route (seconds)",
      "gridPos": { "x": 12, "y": 14, "w": 12, "h": 5 }
    },
    {
      "type": "timeseries",
      "title": "p95 latency by route",
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum by (le, url) (rate(nginx_http_request_duration_seconds_bucket{url!~\"^/ws/|/event\"}[5m])))",
          "legendFormat": "{{url}}"
        }
      ],
      "description": "95th percentile latency per route",
      "gridPos": { "x": 0, "y": 21, "w": 24, "h": 5 }
    }

  ]
}
